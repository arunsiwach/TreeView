--DECLARE @stateid int=0,@schemecode int=10018 ,@kpiid int=0, @datevalue varchar(30)='2025-05-26'     
SET NOCOUNT ON
DECLARE @MindateNonMonthly varchar(30)='',@maxdate varchar(30)='',@IsMnth bit=0
declare @value1 decimal(30,5),@value2 decimal(30,5)
declare @tbltemp table (project_code int ,project_name varchar(250),[label] tinyint,indicator varchar(250),[date] date,national_value decimal(30,5))
-----------------------------------------------------------------------------------------------------------------------------------------------


set @value1=(SELECT  sum(Cumulative_Value) as national_value
from PM_Ujjwala_Phase1_Phase2 
WHERE [date]=(Select max(date) from PM_Ujjwala_Phase1_Phase2 (nolock) where [date]<= @datevalue 
and project_code=70062
)  
AND [label]=1 
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code =70062 --and Data_freq='Daily'
group by [label])

set @value2=(SELECT  sum(Cumulative_Value) as national_value
from PM_Ujjwala_Phase1_Phase2 
WHERE [date]=(Select max(date) from PM_Ujjwala_Phase1_Phase2 (nolock) where [date]<= @datevalue 
and project_code=70062
)  
AND [label]=2 
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code =70062 --and Data_freq='Daily'
group by [label])


insert into @tbltemp
SELECT  project_code,project_name,[label],indicator,[date],sum(Cumulative_Value) as national_value
from PM_Ujjwala_Phase1_Phase2 
WHERE [date]=(Select max(date) from PM_Ujjwala_Phase1_Phase2 (nolock) where [date]<= @datevalue and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code =100383 --and Data_freq='Daily'
group by project_code,project_name,[label],indicator,[Date]

update @tbltemp set national_value=national_value + @value1
where [label]=1
update @tbltemp set national_value=national_value +@value2
where [label]=2

-----------------------------------------------------------------------------------------------------------------------------------------------
Declare @datafreqtbl table (FreqName varchar(50),Id char(2) )
Insert @datafreqtbl
Select 'Daily','NM' union Select 'Weekly','NM' union Select 'Fortnightly','NM' union Select 'Monthly','MM'

select @MindateNonMonthly= isnull(min([Date]),'') from [JJM_Daily_Blocks_Villages_updated] where data_freq NOT IN ('Monthly')
if(@MindateNonMonthly != '') begin 
	SET @IsMnth = CASE when @maxdate<@MindateNonMonthly then 1 else 0 end 
end


SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [Direct_Benefit_Transfer_New] 
WHERE [date]=(Select max(date) from [Direct_Benefit_Transfer_New] (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL

SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from PM_SVANidhi
WHERE [date]=(Select max(date) from PM_SVANidhi (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END  
and Actual_Flag='Cumulative' and Data_freq='Daily'

group by project_code,project_name,[label],indicator,[Date]
UNION
SELECT  project_code,project_name,[label],indicator,@datevalue,sum([value]) as national_value
from PM_SVANidhi
WHERE [date]<=(Select max(date) from PM_SVANidhi (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END  
and Actual_Flag='Current'  and Data_freq='Daily'
group by project_code,project_name,[label],indicator





--order by project_code,[label]
UNION ALL

SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from Swachh_Bharat_Mission_Grameen_New_Daily 
WHERE [date]=(Select max(date) from Swachh_Bharat_Mission_Grameen_New_Daily (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END  
and data_freq='Daily'
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
union all

SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [Swachh Bharat Mission Urban] 
WHERE [date]=(Select max(date) from [Swachh Bharat Mission Urban] (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]





UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [Sukanya Samriddhi Yojana] 
WHERE [date]=(Select max(date) from [Sukanya Samriddhi Yojana] (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from startups_recognized_latest 
WHERE [date]=(Select max(date) from startups_recognized_latest (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,@datevalue,sum([value]) as national_value
from [Stand Up India]
WHERE [date]<=(Select max(date) from [Stand Up India] (nolock) where [date]<= @datevalue and project_code=70019)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code=70019
group by project_code,project_name,[label],indicator
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [Routine Immunization_New] 
WHERE [date]=(Select max(date) from [Routine Immunization_New] (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from PMNDP_Programme_Daily 
WHERE [date]=(Select max(date) from PMNDP_Programme_Daily (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END 
and data_freq='Daily'
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
---------------------------------------------------------------------------------------------------------------------------------------------------


select * from @tbltemp


----------------------------------------------------------------------------------------------------------------------------------------------------
--SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
--from PM_Ujjwala_Phase1_Phase2 
--WHERE [date]=(Select max(date) from PM_Ujjwala_Phase1_Phase2 (nolock) where [date]<= @datevalue and project_code=100383)  
--AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
--and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=100383 and Data_freq='Daily'
--group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from PMSBY 
WHERE [date]=(Select max(date) from PMSBY (nolock) where [date]<= @datevalue )--and project_code=100383)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from PM_POSHAN 
WHERE [date]=(Select max(date) from PM_POSHAN (nolock) where [date]<= @datevalue )--and project_code=70032)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [Nationwide Artificial Insemination Progr_update] 
WHERE [date]=(Select max(date) from [Nationwide Artificial Insemination Progr_update] (nolock) where [date]<= @datevalue )--and project_code=70032)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and Data_freq IN('Daily')
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from PMMY 
WHERE [date]=(Select max(date) from PMMY (nolock) where [date]<= @datevalue )--and project_code=70032)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,@datevalue,sum([value]) as national_value
from [PM Matsya Sampada]
WHERE [date]<=(Select max(date) from [PM Matsya Sampada] (nolock) where [date]<= @datevalue )--and project_code=100447)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=100447
group by project_code,project_name,[label],indicator
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from pm_matru_vandana_updated 
WHERE [date]=(Select max(date) from pm_matru_vandana_updated (nolock) where [date]<= @datevalue )--and project_code=70032)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from PM_kisan_samman_nidhi_latest 
WHERE [date]=(Select max(date) from PM_kisan_samman_nidhi_latest (nolock) where [date]<= @datevalue )--and project_code=70032)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from PMJJBY 
WHERE [date]=(Select max(date) from PMJJBY (nolock) where [date]<= @datevalue )--and project_code=70032)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
--and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from PMJDY 
WHERE [date]=(Select max(date) from PMJDY (nolock) where [date]<= @datevalue and project_code=70032)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code=70032
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [PM Fasal Bima Yojana_New] 
WHERE [date]=(Select max(date) from [PM Fasal Bima Yojana_New] (nolock) where [date]<= @datevalue )--and project_code=100646)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,@datevalue,sum([value]) as national_value
from [Jan Aushadhi Pariyojana_Daily] 
WHERE [date]<=(Select max(date) from [Jan Aushadhi Pariyojana_Daily] (nolock) where [date]<= @datevalue and project_code=100447)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code=100447
--and Data_freq IN ('Daily')
group by project_code,project_name,[label],indicator
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [National Agriculture Market] 
WHERE [date]=(Select max(date) from [National Agriculture Market] (nolock) where [date]<= @datevalue )--and project_code=100646)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,@datevalue,sum([value]) as national_value
from [ujala] 
WHERE [date]<=(Select max(date) from [ujala] (nolock) where [date]<= @datevalue and project_code=70051)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code='70051'
group by project_code,project_name,[label],indicator
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [pm_awaas_yojana_urban_weekly] 
WHERE [date]=(Select max(date) from [pm_awaas_yojana_urban_weekly] (nolock) where [date]<= @datevalue and project_code=100201)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code='100201'
and data_freq in ('Weekly')  
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [pradhan mantri gram sadak yojana] 
WHERE [date]=(Select max(date) from [pradhan mantri gram sadak yojana] (nolock) where [date]<= @datevalue )--and project_code=100646)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [deendayal antyodaya yojana nrlm] 
WHERE [date]=(Select max(date) from [deendayal antyodaya yojana nrlm] (nolock) where [date]<= @datevalue and project_code=100156)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code='100156'
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,@datevalue,sum([value]) as national_value
from [svamitva scheme] 
WHERE [date]<=(Select max(date) from [svamitva scheme] (nolock) where [date]<= @datevalue )--and project_code=100396)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [pradhan mantri awaas yojana gramin] 
WHERE [date]=(Select max(date) from [pradhan mantri awaas yojana gramin] (nolock) where [date]<= @datevalue )--and project_code=70010)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
from [PM_DASBOARD_MGNREGA_Updated] 
WHERE [date]=(Select max(date) from [PM_DASBOARD_MGNREGA_Updated] (nolock) where [date]<= @datevalue )--and project_code=70010)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and data_freq in ('Weekly')
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,@datevalue,sum([value]) as national_value
from [pmkvy_stt] 
WHERE [date]<=(Select max(date) from [pmkvy_stt] (nolock) where [date]<= @datevalue and project_code=100396)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and project_code='100396'
--and Data_freq IN('Daily')
group by project_code,project_name,[label],indicator
--order by project_code,[label]
UNION ALL
--select @MindateNonMonthly= isnull(min([Date]),'') from [JJM_Daily_Blocks_Villages_updated] where data_freq NOT IN ('Monthly')
--if(@MindateNonMonthly != '') begin 
--	SET @IsMnth = CASE when @maxdate<@MindateNonMonthly then 1 else 0 end 
--end
SELECT  project_code,project_name,[label],indicator,[date],sum([value]) as national_value
--SELECT  project_code,project_name,[label],indicator,@datevalue,sum([value]) as national_value
from [JJM_Daily_Blocks_Villages_updated] 
WHERE [date]=(Select max(date) from [JJM_Daily_Blocks_Villages_updated] (nolock) where [date]<= @datevalue )--and project_code=70010)  
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and data_freq IN (Select FreqName from @datafreqtbl where Id = CASE when @IsMnth=1 then 'MM' else 'NM' end )
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[Date],sum([value]) as national_value
from [Agriculture Infrastructure Fund](nolock)
WHERE [date]=(Select max(date) from [Agriculture Infrastructure Fund](nolock) where [date]<= @datevalue) 
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and Data_freq IN('Daily')
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[Date],sum([value]) as national_value
from AB_Health_Wellness_Centres (nolock)
WHERE [date]=(Select max(date) from [AB_Health_Wellness_Centres](nolock) where [date]<= @datevalue) 
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
and data_freq IN ('Weekly')
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[Date],sum([value]) as national_value
from [Development of National Highways]
WHERE [date]=(Select max(date) from [Development of National Highways] (nolock) where [date]<= @datevalue) 
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,[Date],sum([value]) as national_value
from [Common Services Centre](nolock)
WHERE [date]=(Select max(date) from [Common Services Centre](nolock) where [date]<= @datevalue) 
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator,[Date]
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,@maxdate,sum([value]) as national_value
from [BharatNet_CurrentMonth](nolock)
WHERE [date]<=(Select max(date) from [BharatNet_CurrentMonth](nolock) where [date]<= @datevalue) 
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   	
group by project_code,project_name,[label],indicator
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,@maxdate,sum([Current_Value]) as national_value
from [AB PMJAY daily](nolock)	
WHERE [date]<=(Select max(date) from [AB PMJAY daily](nolock) where [date]<= @datevalue) 
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator
--order by project_code,[label]
UNION ALL
SELECT  project_code,project_name,[label],indicator,CAST([Date] AS datetime),sum([value]) as national_value
from APY (nolock)
WHERE [date]=(Select max(date) from [APY](nolock) where [date]<= @datevalue) 
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator,[Date]

UNION ALL
SELECT  project_code,project_name,[label],indicator,CAST([Date] AS datetime),sum([value]) as national_value
from [ONORC_v3] (nolock)
WHERE [date]=(Select max(date) from [ONORC_v3](nolock) where [date]<= @datevalue) 
AND [label]=CASE WHEN @kpiid=0  THEN [label] ELSE @kpiid END  
and state_code=CASE WHEN @stateid=0  THEN state_code ELSE @stateid END   
group by project_code,project_name,[label],indicator,[Date]
order by project_code,[label]
